<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Daily Practice - Habit Tracker</title>
  <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=DM+Sans:wght@400;500&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; padding: 0; }
    #root { width: 100%; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect, useCallback, useMemo } = React;

    // Create storage API using localStorage
    window.storage = {
      get: async (key) => {
        const value = localStorage.getItem(key);
        return value ? { value } : null;
      },
      set: async (key, value) => {
        localStorage.setItem(key, value);
      }
    };

    const DAYS = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];
    const MONTH_NAMES = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
    const DEFAULT_CHECKLISTS = { supplements: [
      { id: "vitd", label: "Vitamin D3" }, { id: "omega3", label: "Omega-3 / Fish Oil" },
      { id: "magnesium", label: "Magnesium" }, { id: "zinc", label: "Zinc" },
      { id: "creatine", label: "Creatine" }, { id: "vitc", label: "Vitamin C" },
    ]};
    const DEFAULT_CATEGORIES = [{ id: "physical", label: "Physical Health" }, { id: "dopamine", label: "Dopamine Regulation" }];
    const INITIAL_HABITS = [
      { id: "gym", label: "Gym Session", category: "physical", icon: "◆", type: "toggle" },
      { id: "stretch", label: "Stretch / Mobility", category: "physical", icon: "◇", type: "toggle" },
      { id: "supplements", label: "Supplements", category: "physical", icon: "●", type: "checklist" },
      { id: "water", label: "Water", category: "physical", icon: "○", type: "counter", target: 8 },
      { id: "cold_shower", label: "Cold Shower", category: "dopamine", icon: "▲", type: "toggle" },
      { id: "meditation", label: "Meditation", category: "dopamine", icon: "△", type: "toggle" },
      { id: "screen_limit", label: "Screen Time Limit", category: "dopamine", icon: "■", type: "toggle" },
      { id: "low_stim", label: "Low-Stim Evening", category: "dopamine", icon: "□", type: "toggle" },
    ];
    const ICON_OPTIONS = ["◆", "◇", "●", "○", "▲", "△", "■", "□", "★", "☆", "♦", "♢", "⬟", "▮", "◉", "⊕"];

    function dkf(date) { return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, "0")}-${String(date.getDate()).padStart(2, "0")}`; }
    function weekDatesOf(ref) {
      const d = new Date(ref), day = d.getDay(), diff = day === 0 ? -6 : 1 - day;
      const mon = new Date(d); mon.setDate(d.getDate() + diff);
      return Array.from({ length: 7 }, (_, i) => { const x = new Date(mon); x.setDate(mon.getDate() + i); return x; });
    }
    function fmtDate(d) { return `${MONTH_NAMES[d.getMonth()]} ${d.getDate()}`; }
    function isTodayDate(d) { return dkf(d) === dkf(new Date()); }
    function dayIdx(d) { const x = d.getDay(); return x === 0 ? 6 : x - 1; }

    // ===== COLOR THEMES =====
    const light = {
      bg: "#f5f0e8", bgAlt: "#ece6da", bgCard: "#fff", bgCardDone: "#f0f4ec", bgSub: "#faf7f2",
      bgCatRow: "#f9f6f0", bgToday: "#f7f4ee", bgSubToday: "#f5f1ea",
      text: "#3d3528", textHeading: "#2c2418", textMuted: "#6b5f50", textFaint: "#a09383", textIcon: "#b8b0a4",
      border: "#e8e1d5", borderLight: "#f0ebe2", borderDone: "#d4dfcc", borderInput: "#d4cfc5",
      accent: "#5a7247", accentBg: "#e8f0e0", accentLink: "#7a8b68",
      danger: "#b05a4a",
      pillActive: "#3d3528", pillActiveText: "#f5f0e8",
      dotDone: "#e8f0e0", dotDoneText: "#5a7247", dotMissed: "#f0ebe2", dotMissedText: "#c4b9a8", dotFutureText: "#ddd6c8",
      progressBg: "#ddd6c8",
      modalOverlay: "rgba(44,36,24,0.3)", modalBg: "#f5f0e8",
      shadow: "0 1px 3px rgba(0,0,0,0.06)", shadowLg: "0 4px 16px rgba(0,0,0,0.1)", shadowXl: "0 8px 32px rgba(0,0,0,0.12)",
    };
    const dark = {
      bg: "#1a1815", bgAlt: "#252219", bgCard: "#2a2620", bgCardDone: "#252e1f", bgSub: "#222019",
      bgCatRow: "#232019", bgToday: "#2e2a22", bgSubToday: "#2a261e",
      text: "#d4cfc5", textHeading: "#e8e3da", textMuted: "#a09383", textFaint: "#726758", textIcon: "#5e5549",
      border: "#3a352c", borderLight: "#322e26", borderDone: "#3a4a2e", borderInput: "#4a4438",
      accent: "#7a9a62", accentBg: "#2e3a22", accentLink: "#8aaa72",
      danger: "#c47060",
      pillActive: "#d4cfc5", pillActiveText: "#1a1815",
      dotDone: "#2e3a22", dotDoneText: "#7a9a62", dotMissed: "#2a2620", dotMissedText: "#5e5549", dotFutureText: "#3a352c",
      progressBg: "#3a352c",
      modalOverlay: "rgba(0,0,0,0.5)", modalBg: "#252219",
      shadow: "0 1px 3px rgba(0,0,0,0.2)", shadowLg: "0 4px 16px rgba(0,0,0,0.3)", shadowXl: "0 8px 32px rgba(0,0,0,0.4)",
    };

    const B = "'DM Sans', sans-serif";
    const S = "'Instrument Serif', serif";

    function mkStyles(c) {
      return {
        container: { margin: "0 auto", padding: "24px 20px 48px", fontFamily: B, color: c.text, background: c.bg, minHeight: "100vh", boxSizing: "border-box", transition: "background 0.3s ease, color 0.3s ease, max-width 0.3s ease", width: "100%" },
        loading: { display: "flex", justifyContent: "center", alignItems: "center", height: "100vh", fontFamily: B, color: c.textFaint, fontSize: 15, background: c.bg },
        header: { marginBottom: 28, maxWidth: 780, margin: "0 auto 28px" },
        headerTop: { display: "flex", justifyContent: "space-between", alignItems: "flex-start" },
        title: { fontFamily: S, fontSize: 32, fontWeight: 400, margin: 0, letterSpacing: -0.5, color: c.textHeading },
        subtitle: { fontSize: 14, color: c.textFaint, marginTop: 2, fontWeight: 400, letterSpacing: 0.3, fontFamily: S },
        settingsBtn: { padding: "6px 8px", border: "none", background: "transparent", borderRadius: 6, cursor: "pointer", color: c.textFaint, display: "flex", alignItems: "center" },
        settingsRow: { display: "flex", justifyContent: "space-between", alignItems: "center", padding: "10px 0", borderBottom: `1px solid ${c.borderLight}` },
        settingsLabel: { fontSize: 14, fontWeight: 500, color: c.text },
        settingsDivider: { height: 1, background: c.border, margin: "16px 0 12px" },
        toggleOff: { width: 44, height: 24, borderRadius: 12, border: "none", background: c.progressBg, cursor: "pointer", position: "relative", padding: 0, transition: "background 0.2s ease" },
        toggleOn: { width: 44, height: 24, borderRadius: 12, border: "none", background: c.accent, cursor: "pointer", position: "relative", padding: 0, transition: "background 0.2s ease" },
        toggleKnobOff: { position: "absolute", top: 3, left: 3, width: 18, height: 18, borderRadius: 9, background: "#fff", transition: "left 0.2s ease", boxShadow: "0 1px 3px rgba(0,0,0,0.15)" },
        toggleKnobOn: { position: "absolute", top: 3, left: 23, width: 18, height: 18, borderRadius: 9, background: "#fff", transition: "left 0.2s ease", boxShadow: "0 1px 3px rgba(0,0,0,0.15)" },
        modeSwitch: { display: "flex", gap: 2, background: c.bgAlt, borderRadius: 8, padding: 3 },
        modeBtn: { padding: "6px 8px", border: "none", background: "transparent", borderRadius: 6, cursor: "pointer", color: c.textFaint, display: "flex", alignItems: "center" },
        modeBtnActive: { padding: "6px 8px", border: "none", background: c.bgCard, borderRadius: 6, cursor: "pointer", color: c.text, display: "flex", alignItems: "center", boxShadow: c.shadow },
        viewToggle: { display: "flex", gap: 4, background: c.bgAlt, borderRadius: 10, padding: 4, maxWidth: 220, margin: "0 auto 24px" },
        viewBtn: { flex: 1, padding: "8px 16px", border: "none", background: "transparent", borderRadius: 8, fontFamily: B, fontSize: 14, color: c.textFaint, cursor: "pointer", fontWeight: 500 },
        viewBtnActive: { flex: 1, padding: "8px 16px", border: "none", background: c.bgCard, borderRadius: 8, fontFamily: B, fontSize: 14, color: c.text, cursor: "pointer", fontWeight: 500, boxShadow: c.shadow },
        dayStripWrap: { display: "flex", alignItems: "center", gap: 4, marginBottom: 16 },
        dayArrow: { width: 32, height: 32, border: "none", background: "transparent", fontSize: 22, color: c.textFaint, cursor: "pointer", display: "flex", alignItems: "center", justifyContent: "center", fontFamily: B, flexShrink: 0, borderRadius: 8 },
        dayStrip: { display: "flex", justifyContent: "space-between", flex: 1, gap: 2 },
        dayPill: { display: "flex", flexDirection: "column", alignItems: "center", gap: 2, padding: "8px 0", flex: 1, border: "none", borderRadius: 12, background: "transparent", cursor: "pointer", fontFamily: B, color: c.text },
        dayPillActive: { background: c.pillActive, color: c.pillActiveText },
        dayPillToday: { border: `1.5px solid ${c.pillActive}` },
        dayPillLabel: { fontSize: 11, fontWeight: 500, textTransform: "uppercase", letterSpacing: 0.5, opacity: 0.7 },
        dayPillNum: { fontSize: 16, fontWeight: 500 },
        dateHeader: { display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 12 },
        dateLabel: { fontSize: 15, fontWeight: 500, color: c.text },
        todayLink: { fontSize: 13, color: c.accentLink, background: "none", border: "none", cursor: "pointer", fontFamily: B, textDecoration: "underline", fontWeight: 500 },
        summaryBar: { display: "flex", alignItems: "center", gap: 12, marginBottom: 24, padding: "12px 16px", background: c.bgAlt, borderRadius: 12 },
        summaryText: { fontSize: 13, color: c.textMuted, whiteSpace: "nowrap", fontWeight: 500 },
        progressTrack: { flex: 1, height: 6, background: c.progressBg, borderRadius: 3, overflow: "hidden" },
        progressFill: { height: "100%", background: c.accent, borderRadius: 3, transition: "width 0.3s ease" },
        futureNote: { fontSize: 13, color: c.textFaint, textAlign: "center", padding: "12px 0", fontStyle: "italic" },
        desktopGrid: { display: "flex", gap: 20 },
        desktopCol: { flex: 1, minWidth: 0, padding: "20px", background: c.bgCard, border: `1px solid ${c.border}`, borderRadius: 16, boxShadow: c.shadow },
        sectionTitle: { fontFamily: S, fontSize: 20, fontWeight: 400, marginBottom: 12, color: c.textHeading, borderBottom: `1px solid ${c.borderLight}`, paddingBottom: 8 },
        habitRow: { display: "flex", justifyContent: "space-between", alignItems: "center", padding: "14px 16px", borderRadius: 12, background: c.bgCard, border: `1px solid ${c.border}`, transition: "all 0.2s ease" },
        habitRowDone: { background: c.bgCardDone, borderColor: c.borderDone },
        habitLeft: { display: "flex", alignItems: "center", gap: 12, flex: 1, minWidth: 0 },
        habitIcon: { fontSize: 16, width: 20, textAlign: "center", flexShrink: 0 },
        habitLabel: { fontSize: 15, fontWeight: 500, color: c.text, display: "block" },
        habitLabelDone: { color: c.accent },
        noteIndicator: { fontSize: 11, color: c.textFaint, fontStyle: "italic" },
        clCount: { fontSize: 12, color: c.textFaint, fontWeight: 400 },
        habitRight: { display: "flex", alignItems: "center", gap: 6, flexShrink: 0, position: "relative" },
        checkDone: { width: 36, height: 36, borderRadius: 10, border: `2px solid ${c.accent}`, background: c.accent, color: "#fff", fontSize: 18, cursor: "pointer", display: "flex", alignItems: "center", justifyContent: "center", fontFamily: B, lineHeight: 1 },
        checkUndone: { width: 36, height: 36, borderRadius: 10, border: `2px solid ${c.borderInput}`, background: "transparent", color: "transparent", fontSize: 18, cursor: "pointer", display: "flex", alignItems: "center", justifyContent: "center" },
        counterGroup: { display: "flex", alignItems: "center", gap: 6 },
        counterBtn: { width: 32, height: 32, borderRadius: 8, border: `1.5px solid ${c.borderInput}`, background: c.bgCard, fontSize: 18, cursor: "pointer", color: c.text, display: "flex", alignItems: "center", justifyContent: "center", fontFamily: B, lineHeight: 1 },
        counterVal: { fontSize: 16, fontWeight: 500, minWidth: 36, textAlign: "center", color: c.text },
        counterTarget: { fontSize: 12, color: c.textFaint, fontWeight: 400 },
        expandBtn: { width: 36, height: 36, borderRadius: 10, border: `2px solid ${c.borderInput}`, background: c.bgCard, fontSize: 16, cursor: "pointer", color: c.textMuted, display: "flex", alignItems: "center", justifyContent: "center" },
        menuBtn: { width: 28, height: 28, borderRadius: 7, border: "none", background: "transparent", fontSize: 18, cursor: "pointer", color: c.textIcon, display: "flex", alignItems: "center", justifyContent: "center", letterSpacing: 2 },
        menuBackdrop: { position: "fixed", inset: 0, zIndex: 50 },
        contextMenu: { position: "absolute", top: "calc(100% + 4px)", right: 0, background: c.bgCard, border: `1px solid ${c.border}`, borderRadius: 10, boxShadow: c.shadowLg, zIndex: 51, overflow: "hidden", minWidth: 175 },
        contextItem: { display: "flex", alignItems: "center", gap: 8, width: "100%", padding: "10px 14px", border: "none", background: "transparent", fontFamily: B, fontSize: 14, color: c.text, cursor: "pointer", textAlign: "left" },
        contextItemDanger: { color: c.danger },
        ctxIcon: { fontSize: 12, width: 16, textAlign: "center", flexShrink: 0, opacity: 0.6 },
        ctxDivider: { height: 1, background: c.borderLight, margin: "2px 0" },
        typeHint: { fontSize: 12, color: c.textFaint, marginTop: 6, fontStyle: "italic", lineHeight: 1.4 },
        clDropdown: { padding: "10px 16px", background: c.bgSub, borderRadius: "0 0 12px 12px", border: `1px solid ${c.border}`, borderTop: "none" },
        clRow: { display: "flex", alignItems: "center", gap: 10, padding: "7px 0", borderBottom: `1px solid ${c.borderLight}` },
        clCheckDone: { width: 26, height: 26, borderRadius: 7, border: `1.5px solid ${c.accent}`, background: c.accent, color: "#fff", fontSize: 13, cursor: "pointer", display: "flex", alignItems: "center", justifyContent: "center", flexShrink: 0 },
        clCheckUndone: { width: 26, height: 26, borderRadius: 7, border: `1.5px solid ${c.borderInput}`, background: "transparent", color: "transparent", fontSize: 13, cursor: "pointer", display: "flex", alignItems: "center", justifyContent: "center", flexShrink: 0 },
        clLabel: { fontSize: 14, color: c.text },
        clLabelDone: { color: c.accent },
        clRemove: { marginLeft: "auto", background: "none", border: "none", fontSize: 15, color: c.textIcon, cursor: "pointer", padding: "2px 6px" },
        clEmpty: { fontSize: 13, color: c.textFaint, fontStyle: "italic", margin: "4px 0 8px" },
        addClBtn: { marginTop: 8, background: "none", border: "none", fontSize: 13, color: c.accentLink, cursor: "pointer", fontFamily: B, fontWeight: 500, padding: 0 },
        addHabitBtn: { display: "block", margin: "20px auto 0", padding: "10px 20px", border: `1.5px dashed ${c.borderInput}`, borderRadius: 12, background: "transparent", fontFamily: B, fontSize: 14, color: c.textFaint, cursor: "pointer", fontWeight: 500, width: "100%", maxWidth: 260 },
        weekNav: { display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 20 },
        weekNavBtn: { fontSize: 13, color: c.accentLink, background: "none", border: "none", cursor: "pointer", fontFamily: B, fontWeight: 500 },
        weekRange: { fontSize: 15, fontWeight: 500, color: c.text },
        statsRow: { display: "flex", gap: 8, marginBottom: 24 },
        statCard: { flex: 1, display: "flex", flexDirection: "column", alignItems: "center", gap: 2, background: c.bgCard, border: `1px solid ${c.border}`, borderRadius: 12, padding: "16px 8px" },
        statNum: { fontFamily: S, fontSize: 28, color: c.textHeading },
        statLabel: { fontSize: 11, color: c.textFaint, textTransform: "uppercase", letterSpacing: 0.5, fontWeight: 500 },
        gridContainer: { background: c.bgCard, borderRadius: 12, border: `1px solid ${c.border}`, overflow: "hidden" },
        gridHeader: { display: "flex", borderBottom: `1px solid ${c.border}` },
        gridLabelCol: { padding: "8px 12px", display: "flex", alignItems: "center", gap: 6, flexShrink: 0 },
        gridDayCol: { flex: 1, display: "flex", flexDirection: "column", alignItems: "center", gap: 1, padding: "8px 0" },
        gridDayToday: { background: c.bgToday },
        gridDayName: { fontSize: 10, fontWeight: 500, color: c.textFaint, textTransform: "uppercase", letterSpacing: 0.5 },
        gridDayNum: { fontSize: 13, fontWeight: 500, color: c.text },
        gridCatRow: { display: "flex", borderBottom: `1px solid ${c.border}`, background: c.bgCatRow },
        gridCatLabel: { fontSize: 14, fontFamily: S, fontWeight: 400, color: c.textHeading },
        gridRow: { display: "flex", borderBottom: `1px solid ${c.borderLight}` },
        gridHabitIcon: { fontSize: 12, color: c.textIcon },
        gridHabitLabel: { fontSize: 12, color: c.textMuted, fontWeight: 500 },
        gridSubLabel: { fontSize: 11, color: c.textFaint },
        gridCell: { flex: 1, display: "flex", alignItems: "center", justifyContent: "center", padding: "8px 0" },
        gridCellCol: { flexDirection: "column", gap: 2 },
        gridCellToday: { background: c.bgToday },
        gridDot: { width: 24, height: 24, borderRadius: 6, display: "flex", alignItems: "center", justifyContent: "center", fontSize: 12, fontWeight: 500 },
        gridDotFuture: { background: "transparent", color: c.dotFutureText },
        gridDotDoneBtn: { width: 28, height: 28, borderRadius: 7, border: "none", background: c.dotDone, color: c.dotDoneText, fontSize: 11, fontWeight: 600, cursor: "pointer", display: "flex", alignItems: "center", justifyContent: "center", fontFamily: B },
        gridDotMissedBtn: { width: 28, height: 28, borderRadius: 7, border: "none", background: c.dotMissed, color: c.dotMissedText, fontSize: 11, fontWeight: 600, cursor: "pointer", display: "flex", alignItems: "center", justifyContent: "center", fontFamily: B },
        gridCounterWrap: { display: "flex", alignItems: "center", gap: 2 },
        gridCounterBtn: { width: 20, height: 20, borderRadius: 4, border: `1px solid ${c.progressBg}`, background: c.bgCard, fontSize: 13, cursor: "pointer", color: c.textMuted, display: "flex", alignItems: "center", justifyContent: "center", fontFamily: B, lineHeight: 1, padding: 0 },
        gridCounterVal: { fontSize: 12, fontWeight: 600, minWidth: 16, textAlign: "center" },
        gridSubDone: { width: 22, height: 22, borderRadius: 5, border: `1.5px solid ${c.accent}`, background: c.accent, color: "#fff", fontSize: 11, cursor: "pointer", display: "flex", alignItems: "center", justifyContent: "center", flexShrink: 0 },
        gridSubUndone: { width: 22, height: 22, borderRadius: 5, border: `1.5px solid ${c.borderInput}`, background: "transparent", color: "transparent", fontSize: 11, cursor: "pointer", display: "flex", alignItems: "center", justifyContent: "center", flexShrink: 0 },
        gridSubRowBg: { background: c.bgSub },
        gridSubTodayBg: { background: c.bgSubToday },
        goTodayBtn: { display: "block", margin: "20px auto 0", padding: "10px 20px", border: `1px solid ${c.borderInput}`, borderRadius: 10, background: c.bgCard, fontFamily: B, fontSize: 14, color: c.text, cursor: "pointer", fontWeight: 500 },
        weekNoteWrap: { marginTop: 20, padding: "16px", background: c.bgCard, border: `1px solid ${c.border}`, borderRadius: 12 },
        weekNoteHeader: { display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 8 },
        weekNoteTitle: { fontSize: 13, fontWeight: 500, color: c.textMuted, textTransform: "uppercase", letterSpacing: 0.5 },
        weekNoteEditBtn: { background: "none", border: "none", fontSize: 14, color: c.textFaint, cursor: "pointer" },
        weekNoteText: { fontSize: 14, color: c.text, margin: 0, lineHeight: 1.5, cursor: "pointer", whiteSpace: "pre-wrap" },
        catRow: { display: "flex", alignItems: "center", gap: 8, padding: "10px 12px", background: c.bgCard, borderRadius: 10, border: `1px solid ${c.border}`, marginBottom: 4 },
        catLabel: { flex: 1, fontSize: 14, fontWeight: 500, color: c.text },
        catCount: { fontSize: 12, color: c.textFaint, whiteSpace: "nowrap" },
        catActionBtn: { width: 28, height: 28, borderRadius: 7, border: "none", background: "transparent", fontSize: 14, cursor: "pointer", color: c.textFaint, display: "flex", alignItems: "center", justifyContent: "center" },
        modalOverlay: { position: "fixed", inset: 0, background: c.modalOverlay, display: "flex", alignItems: "center", justifyContent: "center", zIndex: 1000, padding: 16 },
        modal: { background: c.modalBg, borderRadius: 16, padding: 24, maxWidth: 400, width: "100%", boxShadow: c.shadowXl },
        modalTitle: { fontFamily: S, fontSize: 18, margin: "0 0 16px", color: c.textHeading },
        textarea: { width: "100%", border: `1px solid ${c.borderInput}`, borderRadius: 10, padding: 12, fontFamily: B, fontSize: 14, resize: "vertical", background: c.bgCard, color: c.text, boxSizing: "border-box", outline: "none" },
        input: { width: "100%", border: `1px solid ${c.borderInput}`, borderRadius: 10, padding: "10px 12px", fontFamily: B, fontSize: 14, background: c.bgCard, color: c.text, boxSizing: "border-box", outline: "none" },
        fieldLabel: { fontSize: 12, fontWeight: 500, color: c.textMuted, marginBottom: 4, display: "block", textTransform: "uppercase", letterSpacing: 0.5 },
        chip: { padding: "6px 12px", border: `1px solid ${c.borderInput}`, borderRadius: 8, background: c.bgCard, fontFamily: B, fontSize: 13, color: c.textMuted, cursor: "pointer" },
        chipActive: { padding: "6px 12px", border: `1px solid ${c.accent}`, borderRadius: 8, background: c.accentBg, fontFamily: B, fontSize: 13, color: c.accent, cursor: "pointer", fontWeight: 500 },
        iconPick: { width: 32, height: 32, border: `1px solid ${c.border}`, borderRadius: 6, background: c.bgCard, cursor: "pointer", fontSize: 14, display: "flex", alignItems: "center", justifyContent: "center", color: c.text },
        iconPickActive: { width: 32, height: 32, border: `2px solid ${c.accent}`, borderRadius: 6, background: c.accentBg, cursor: "pointer", fontSize: 14, display: "flex", alignItems: "center", justifyContent: "center", color: c.text },
        modalActions: { display: "flex", justifyContent: "flex-end", gap: 8, marginTop: 12 },
        modalCancel: { padding: "8px 16px", border: `1px solid ${c.borderInput}`, borderRadius: 8, background: "transparent", fontFamily: B, fontSize: 14, color: c.textMuted, cursor: "pointer" },
        modalSave: { padding: "8px 16px", border: "none", borderRadius: 8, background: c.pillActive, fontFamily: B, fontSize: 14, color: c.pillActiveText, cursor: "pointer", fontWeight: 500 },
        modalSaveDestructive: { padding: "8px 16px", border: "none", borderRadius: 8, background: c.danger, fontFamily: B, fontSize: 14, color: "#fff", cursor: "pointer", fontWeight: 500 },
      };
    }

    // ===== APP =====
    function HabitTracker() {
      const [habits, setHabits] = useState(INITIAL_HABITS);
      const [categories, setCategories] = useState(DEFAULT_CATEGORIES);
      const [logs, setLogs] = useState({});
      const [notes, setNotes] = useState({});
      const [weekNotes, setWeekNotes] = useState({});
      const [checklists, setChecklists] = useState(DEFAULT_CHECKLISTS);
      const [view, setView] = useState("daily");
      const [selectedDate, setSelectedDate] = useState(new Date());
      const [noteModal, setNoteModal] = useState(null);
      const [noteText, setNoteText] = useState("");
      const [addModal, setAddModal] = useState(false);
      const [editModal, setEditModal] = useState(null);
      const [deleteConfirm, setDeleteConfirm] = useState(null);
      const [catModal, setCatModal] = useState(false);
      const [editCatId, setEditCatId] = useState(null);
      const [editCatLabel, setEditCatLabel] = useState("");
      const [newCatName, setNewCatName] = useState("");
      const [addSubModal, setAddSubModal] = useState(null);
      const [newSubName, setNewSubName] = useState("");
      const [newHabit, setNewHabit] = useState({ label: "", category: "", icon: "★", type: "toggle", target: 4 });
      const [editData, setEditData] = useState({ label: "", icon: "◆", category: "" });
      const [displayMode, setDisplayMode] = useState("mobile");
      const [theme, setTheme] = useState("light");
      const [loaded, setLoaded] = useState(false);

      const st = useMemo(() => mkStyles(theme === "dark" ? dark : light), [theme]);
      const isDark = theme === "dark";

      useEffect(() => {
        document.body.style.background = isDark ? dark.bg : light.bg;
      }, [isDark]);

      useEffect(() => {
        (async () => {
          try { const r = await window.storage.get("ht-habits"); if (r) setHabits(JSON.parse(r.value)); } catch {}
          try { const r = await window.storage.get("ht-categories"); if (r) setCategories(JSON.parse(r.value)); } catch {}
          try { const r = await window.storage.get("ht-logs"); if (r) setLogs(JSON.parse(r.value)); } catch {}
          try { const r = await window.storage.get("ht-notes"); if (r) setNotes(JSON.parse(r.value)); } catch {}
          try { const r = await window.storage.get("ht-weeknotes"); if (r) setWeekNotes(JSON.parse(r.value)); } catch {}
          try { const r = await window.storage.get("ht-checklists"); if (r) setChecklists(JSON.parse(r.value)); } catch {}
          try { const r = await window.storage.get("ht-theme"); if (r) setTheme(r.value); } catch {}
          setLoaded(true);
        })();
      }, []);

      const persist = useCallback(async (key, val, setter) => {
        setter(val); try { await window.storage.set(key, JSON.stringify(val)); } catch {}
      }, []);
      const saveHabits = v => persist("ht-habits", v, setHabits);
      const saveCategories = v => persist("ht-categories", v, setCategories);
      const saveLogs = v => persist("ht-logs", v, setLogs);
      const saveNotes = v => persist("ht-notes", v, setNotes);
      const saveWeekNotes = v => persist("ht-weeknotes", v, setWeekNotes);
      const saveChecklists = v => persist("ht-checklists", v, setChecklists);
      const toggleTheme = async () => {
        const next = isDark ? "light" : "dark"; setTheme(next);
        try { await window.storage.set("ht-theme", next); } catch {}
      };

      const dateKey = dkf(selectedDate);
      const dayLogs = logs[dateKey] || {};
      const weekDates = weekDatesOf(selectedDate);
      const weekKey = dkf(weekDates[0]);

      const toggleHabitOn = dk => id => { const dl = logs[dk] || {}; saveLogs({ ...logs, [dk]: { ...dl, [id]: !dl[id] } }); };
      const toggleChecklistItemOn = dk => (hId, sId) => {
        const dl = logs[dk] || {}; const det = dl[hId + "_detail"] || {};
        const nd = { ...det, [sId]: !det[sId] }; const items = checklists[hId] || [];
        saveLogs({ ...logs, [dk]: { ...dl, [hId + "_detail"]: nd, [hId]: items.length > 0 && items.every(it => nd[it.id]) } });
      };
      const adjustCounterOn = dk => (id, delta) => { const dl = logs[dk] || {}; saveLogs({ ...logs, [dk]: { ...dl, [id]: Math.max(0, (dl[id] || 0) + delta) } }); };
      const toggleHabit = toggleHabitOn(dateKey);
      const toggleChecklistItem = toggleChecklistItemOn(dateKey);
      const adjustCounter = adjustCounterOn(dateKey);

      const openNote = id => { setNoteText(notes[`${dateKey}:${id}`] || ""); setNoteModal(id); };
      const saveNote = () => { saveNotes({ ...notes, [`${dateKey}:${noteModal}`]: noteText }); setNoteModal(null); };
      const addHabit = () => {
        if (!newHabit.label.trim() || !newHabit.category) return;
        const id = "h_" + Date.now(); const h = { ...newHabit, id }; if (h.type !== "counter") delete h.target;
        saveHabits([...habits, h]); if (h.type === "checklist") saveChecklists({ ...checklists, [id]: [] });
        setNewHabit({ label: "", category: categories[0]?.id || "", icon: "★", type: "toggle", target: 4 }); setAddModal(false);
      };
      const openEdit = h => { setEditData({ label: h.label, icon: h.icon, category: h.category }); setEditModal(h.id); };
      const saveEdit = () => { if (!editData.label.trim()) return; saveHabits(habits.map(h => h.id === editModal ? { ...h, label: editData.label.trim(), icon: editData.icon, category: editData.category } : h)); setEditModal(null); };
      const confirmDelete = id => setDeleteConfirm(id);
      const executeDelete = () => { saveHabits(habits.filter(h => h.id !== deleteConfirm)); const nc = { ...checklists }; delete nc[deleteConfirm]; saveChecklists(nc); setDeleteConfirm(null); };
      const addSubItem = () => { if (!newSubName.trim() || !addSubModal) return; saveChecklists({ ...checklists, [addSubModal]: [...(checklists[addSubModal] || []), { id: "si_" + Date.now(), label: newSubName.trim() }] }); setNewSubName(""); setAddSubModal(null); };
      const removeSubItem = (hId, sId) => saveChecklists({ ...checklists, [hId]: (checklists[hId] || []).filter(it => it.id !== sId) });
      const addCategory = () => { if (!newCatName.trim()) return; saveCategories([...categories, { id: "cat_" + Date.now(), label: newCatName.trim() }]); setNewCatName(""); };
      const startEditCat = c => { setEditCatId(c.id); setEditCatLabel(c.label); };
      const saveEditCat = () => { if (!editCatLabel.trim()) return; saveCategories(categories.map(c => c.id === editCatId ? { ...c, label: editCatLabel.trim() } : c)); setEditCatId(null); };
      const deleteCat = id => { if (!habits.some(h => h.category === id)) saveCategories(categories.filter(c => c.id !== id)); };

      const getHabitStatus = (h, dk) => { const dl = logs[dk] || {}; if (h.type === "toggle") return dl[h.id] ? "done" : "missed"; if (h.type === "counter") return (dl[h.id] || 0) >= h.target ? "done" : "missed"; if (h.type === "checklist") return dl[h.id] ? "done" : "missed"; return "missed"; };
      const weekStats = () => { let t = 0, d = 0; const tk = dkf(new Date()); weekDates.forEach(dd => { const k = dkf(dd); if (k > tk) return; habits.forEach(h => { t++; if (getHabitStatus(h, k) === "done") d++; }); }); return { total: t, done: d, pct: t > 0 ? Math.round((d / t) * 100) : 0 }; };
      const gymCount = () => { let c = 0; weekDates.forEach(d => { if ((logs[dkf(d)] || {})["gym"]) c++; }); return c; };
      const navigateWeek = dir => { const d = new Date(selectedDate); d.setDate(d.getDate() + dir * 7); setSelectedDate(d); };
      const navigateDay = dir => { const d = new Date(selectedDate); d.setDate(d.getDate() + dir); setSelectedDate(d); };
      const goToday = () => setSelectedDate(new Date());
      const isDesktop = displayMode === "desktop";

      const CategoryPicker = ({ value, onChange }) => (
        <div><label style={st.fieldLabel}>Category</label>
          <div style={{ display: "flex", flexWrap: "wrap", gap: 4 }}>
            {categories.map(c => <button key={c.id} style={value === c.id ? st.chipActive : st.chip} onClick={() => onChange(c.id)}>{c.label}</button>)}
          </div>
        </div>
      );

      if (!loaded) return <div style={st.loading}>Loading...</div>;

      return (
        <div style={{ ...st.container, maxWidth: isDesktop ? 1200 : 520 }}>
          <header style={st.header}>
            <div style={st.headerTop}>
              <div>
                <h1 style={st.title}>Daily Practice</h1>
                <p style={st.subtitle}><em>Vince te ipsum</em></p>
              </div>
              <button style={st.settingsBtn} onClick={() => setCatModal(true)} title="Settings">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.8" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
              </button>
            </div>
          </header>

          <div style={st.viewToggle}>
            <button style={view === "daily" ? st.viewBtnActive : st.viewBtn} onClick={() => setView("daily")}>Today</button>
            <button style={view === "weekly" ? st.viewBtnActive : st.viewBtn} onClick={() => setView("weekly")}>Week</button>
          </div>

          {view === "daily" ? (
            <DailyView st={st} habits={habits} categories={categories} dayLogs={dayLogs} dateKey={dateKey} selectedDate={selectedDate}
              notes={notes} checklists={checklists} toggleHabit={toggleHabit} toggleChecklistItem={toggleChecklistItem}
              adjustCounter={adjustCounter} openNote={openNote} weekDates={weekDates}
              setSelectedDate={setSelectedDate} goToday={goToday} navigateDay={navigateDay}
              onAddHabit={() => { setNewHabit({ label: "", category: categories[0]?.id || "", icon: "★", type: "toggle", target: 4 }); setAddModal(true); }}
              onEditHabit={openEdit} onDeleteHabit={confirmDelete}
              onAddSubItem={hId => { setNewSubName(""); setAddSubModal(hId); }} onRemoveSubItem={removeSubItem} isDesktop={isDesktop} />
          ) : (
            <WeeklyView st={st} habits={habits} categories={categories} weekDates={weekDates} logs={logs} checklists={checklists}
              navigateWeek={navigateWeek} goToday={goToday} weekStats={weekStats} gymCount={gymCount}
              getHabitStatus={getHabitStatus} selectedDate={selectedDate} isDesktop={isDesktop}
              toggleHabitOn={toggleHabitOn} toggleChecklistItemOn={toggleChecklistItemOn} adjustCounterOn={adjustCounterOn}
              weekNote={weekNotes[weekKey] || ""} setWeekNote={val => saveWeekNotes({ ...weekNotes, [weekKey]: val })} weekKey={weekKey} />
          )}

          {noteModal && <Modal st={st} onClose={() => setNoteModal(null)}>
            <p style={st.modalTitle}>Quick note — {habits.find(h => h.id === noteModal)?.label}</p>
            <textarea style={st.textarea} value={noteText} onChange={e => setNoteText(e.target.value)} placeholder="Focus areas, stretches, how it felt..." rows={3} autoFocus />
            <div style={st.modalActions}><button style={st.modalCancel} onClick={() => setNoteModal(null)}>Cancel</button><button style={st.modalSave} onClick={saveNote}>Save</button></div>
          </Modal>}
          {addModal && <Modal st={st} onClose={() => setAddModal(false)}>
            <p style={st.modalTitle}>Add a habit</p>
            <input style={st.input} placeholder="Habit name" value={newHabit.label} onChange={e => setNewHabit({ ...newHabit, label: e.target.value })} autoFocus />
            <div style={{ marginTop: 12 }}><CategoryPicker value={newHabit.category} onChange={cat => setNewHabit({ ...newHabit, category: cat })} /></div>
            <div style={{ marginTop: 12 }}><label style={st.fieldLabel}>Type</label>
              <div style={{ display: "flex", flexWrap: "wrap", gap: 4 }}>
                <button style={newHabit.type === "toggle" ? st.chipActive : st.chip} onClick={() => setNewHabit({ ...newHabit, type: "toggle" })}>Check</button>
                <button style={newHabit.type === "counter" ? st.chipActive : st.chip} onClick={() => setNewHabit({ ...newHabit, type: "counter" })}>Counter</button>
                <button style={newHabit.type === "checklist" ? st.chipActive : st.chip} onClick={() => setNewHabit({ ...newHabit, type: "checklist" })}>Checklist</button>
              </div>
              {newHabit.type === "checklist" && <p style={st.typeHint}>A group of sub-items you tick off individually. Add items after creating.</p>}
            </div>
            {newHabit.type === "counter" && <div style={{ marginTop: 12 }}><label style={st.fieldLabel}>Daily target</label><input style={{ ...st.input, width: 80 }} type="number" min={1} value={newHabit.target || 4} onChange={e => setNewHabit({ ...newHabit, target: parseInt(e.target.value) || 1 })} /></div>}
            <div style={{ marginTop: 12 }}><label style={st.fieldLabel}>Icon</label><div style={{ display: "flex", flexWrap: "wrap", gap: 4 }}>{ICON_OPTIONS.map(i => <button key={i} onClick={() => setNewHabit({ ...newHabit, icon: i })} style={newHabit.icon === i ? st.iconPickActive : st.iconPick}>{i}</button>)}</div></div>
            <div style={{ ...st.modalActions, marginTop: 16 }}><button style={st.modalCancel} onClick={() => setAddModal(false)}>Cancel</button><button style={st.modalSave} onClick={addHabit}>Add habit</button></div>
          </Modal>}
          {editModal && <Modal st={st} onClose={() => setEditModal(null)}>
            <p style={st.modalTitle}>Edit habit</p>
            <input style={st.input} value={editData.label} onChange={e => setEditData({ ...editData, label: e.target.value })} autoFocus />
            <div style={{ marginTop: 12 }}><CategoryPicker value={editData.category} onChange={cat => setEditData({ ...editData, category: cat })} /></div>
            <div style={{ marginTop: 12 }}><label style={st.fieldLabel}>Icon</label><div style={{ display: "flex", flexWrap: "wrap", gap: 4 }}>{ICON_OPTIONS.map(i => <button key={i} onClick={() => setEditData({ ...editData, icon: i })} style={editData.icon === i ? st.iconPickActive : st.iconPick}>{i}</button>)}</div></div>
            <div style={{ ...st.modalActions, marginTop: 16 }}><button style={st.modalCancel} onClick={() => setEditModal(null)}>Cancel</button><button style={st.modalSave} onClick={saveEdit}>Save changes</button></div>
          </Modal>}
          {deleteConfirm && <Modal st={st} onClose={() => setDeleteConfirm(null)}>
            <p style={st.modalTitle}>Delete habit?</p>
            <p style={{ fontSize: 14, color: st.habitLabel.color, margin: "0 0 4px" }}>Delete <strong>{habits.find(h => h.id === deleteConfirm)?.label}</strong>?</p>
            <p style={{ fontSize: 13, color: st.clCount.color, margin: 0 }}>Logged data stays — the habit just disappears from your tracker.</p>
            <div style={{ ...st.modalActions, marginTop: 16 }}><button style={st.modalCancel} onClick={() => setDeleteConfirm(null)}>Keep it</button><button style={st.modalSaveDestructive} onClick={executeDelete}>Delete</button></div>
          </Modal>}
          {addSubModal && <Modal st={st} onClose={() => setAddSubModal(null)}>
            <p style={st.modalTitle}>Add item to {habits.find(h => h.id === addSubModal)?.label}</p>
            <input style={st.input} placeholder="Item name" value={newSubName} onChange={e => setNewSubName(e.target.value)} autoFocus onKeyDown={e => e.key === "Enter" && addSubItem()} />
            <div style={{ ...st.modalActions, marginTop: 12 }}><button style={st.modalCancel} onClick={() => setAddSubModal(null)}>Cancel</button><button style={st.modalSave} onClick={addSubItem}>Add</button></div>
          </Modal>}
          {catModal && <Modal st={st} onClose={() => { setCatModal(false); setEditCatId(null); }}>
            <p style={st.modalTitle}>Settings</p>

            <div style={st.settingsRow}>
              <span style={st.settingsLabel}>Dark mode</span>
              <button style={isDark ? st.toggleOn : st.toggleOff} onClick={toggleTheme}>
                <span style={isDark ? st.toggleKnobOn : st.toggleKnobOff} />
              </button>
            </div>

            <div style={st.settingsRow}>
              <span style={st.settingsLabel}>Display</span>
              <div style={st.modeSwitch}>
                <button style={!isDesktop ? st.modeBtnActive : st.modeBtn} onClick={() => setDisplayMode("mobile")} title="Mobile">
                  <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><rect x="4" y="1" width="8" height="14" rx="1.5" stroke="currentColor" strokeWidth="1.5"/><circle cx="8" cy="12.5" r="0.75" fill="currentColor"/></svg>
                </button>
                <button style={isDesktop ? st.modeBtnActive : st.modeBtn} onClick={() => setDisplayMode("desktop")} title="Desktop">
                  <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><rect x="1" y="2" width="14" height="10" rx="1.5" stroke="currentColor" strokeWidth="1.5"/><path d="M5 14h6" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round"/></svg>
                </button>
              </div>
            </div>

            <div style={st.settingsDivider} />

            <p style={{ fontFamily: "'Instrument Serif', serif", fontSize: 16, color: st.modalTitle.color, margin: "4px 0 10px" }}>Categories</p>
            <div style={{ display: "flex", flexDirection: "column", gap: 2 }}>
              {categories.map(cat => { const hc = habits.filter(h => h.category === cat.id).length; const isEd = editCatId === cat.id; return (
                <div key={cat.id} style={st.catRow}>
                  {isEd ? <input style={{ ...st.input, flex: 1, padding: "6px 10px" }} value={editCatLabel} onChange={e => setEditCatLabel(e.target.value)} autoFocus onKeyDown={e => { if (e.key === "Enter") saveEditCat(); if (e.key === "Escape") setEditCatId(null); }} /> : <span style={st.catLabel}>{cat.label}</span>}
                  <span style={st.catCount}>{hc}</span>
                  <div style={{ display: "flex", gap: 2 }}>{isEd ? <><button style={st.catActionBtn} onClick={saveEditCat}>✓</button><button style={st.catActionBtn} onClick={() => setEditCatId(null)}>✕</button></> : <><button style={st.catActionBtn} onClick={() => startEditCat(cat)}>✎</button><button style={{ ...st.catActionBtn, ...(hc > 0 ? { opacity: 0.25, cursor: "default" } : { color: dark.danger }) }} onClick={() => hc === 0 && deleteCat(cat.id)}>✕</button></>}</div>
                </div>); })}
            </div>
            <div style={{ display: "flex", gap: 8, marginTop: 10, alignItems: "center" }}><input style={{ ...st.input, flex: 1 }} placeholder="New category name" value={newCatName} onChange={e => setNewCatName(e.target.value)} onKeyDown={e => e.key === "Enter" && addCategory()} /><button style={{ ...st.modalSave, whiteSpace: "nowrap", opacity: newCatName.trim() ? 1 : 0.4 }} onClick={addCategory}>Add</button></div>
            <div style={{ ...st.modalActions, marginTop: 16 }}><button style={st.modalSave} onClick={() => { setCatModal(false); setEditCatId(null); }}>Done</button></div>
          </Modal>}
        </div>
      );
    }

    function Modal({ st, children, onClose }) {
      return <div style={st.modalOverlay} onClick={onClose}><div style={st.modal} onClick={e => e.stopPropagation()}>{children}</div></div>;
    }

    function DailyView({ st, habits, categories, dayLogs, dateKey, selectedDate, notes, checklists, toggleHabit, toggleChecklistItem,
      adjustCounter, openNote, weekDates, setSelectedDate, goToday, navigateDay, onAddHabit, onEditHabit, onDeleteHabit,
      onAddSubItem, onRemoveSubItem, isDesktop }) {
      const todayKey = dkf(new Date()); const isFuture = dateKey > todayKey;
      const completedCount = habits.filter(h => { if (h.type === "toggle") return dayLogs[h.id]; if (h.type === "counter") return (dayLogs[h.id] || 0) >= h.target; if (h.type === "checklist") return dayLogs[h.id]; return false; }).length;
      const grouped = categories.map(c => ({ ...c, habits: habits.filter(h => h.category === c.id) })).filter(g => g.habits.length > 0);
      const orphans = habits.filter(h => !categories.some(c => c.id === h.category)); if (orphans.length) grouped.push({ id: "_other", label: "Other", habits: orphans });
      const mid = Math.ceil(grouped.length / 2), col1 = grouped.slice(0, mid), col2 = grouped.slice(mid);
      const renderGroup = g => (<div key={g.id} style={{ marginBottom: 4 }}><h2 style={st.sectionTitle}>{g.label}</h2>
        {g.habits.map(h => <HabitRow key={h.id} st={st} habit={h} dayLogs={dayLogs} dateKey={dateKey} notes={notes} checklistItems={checklists[h.id] || []} toggle={toggleHabit} toggleChecklistItem={toggleChecklistItem} adjust={adjustCounter} openNote={openNote} onEdit={() => onEditHabit(h)} onDelete={() => onDeleteHabit(h.id)} onAddSubItem={() => onAddSubItem(h.id)} onRemoveSubItem={sId => onRemoveSubItem(h.id, sId)} />)}</div>);
      return (<div>
        <div style={st.dayStripWrap}><button style={st.dayArrow} onClick={() => navigateDay(-7)}>‹</button><div style={st.dayStrip}>{weekDates.map(d => { const k = dkf(d), active = k === dateKey, today = isTodayDate(d); return (<button key={k} style={{ ...st.dayPill, ...(active ? st.dayPillActive : {}), ...(today && !active ? st.dayPillToday : {}) }} onClick={() => setSelectedDate(new Date(d))}><span style={st.dayPillLabel}>{DAYS[dayIdx(d)]}</span><span style={st.dayPillNum}>{d.getDate()}</span></button>); })}</div><button style={st.dayArrow} onClick={() => navigateDay(7)}>›</button></div>
        <div style={st.dateHeader}><span style={st.dateLabel}>{fmtDate(selectedDate)}{isTodayDate(selectedDate) ? " — Today" : ""}</span>{!isTodayDate(selectedDate) && <button style={st.todayLink} onClick={goToday}>Go to today</button>}</div>
        <div style={st.summaryBar}><span style={st.summaryText}>{completedCount} of {habits.length}</span><div style={st.progressTrack}><div style={{ ...st.progressFill, width: `${habits.length ? (completedCount / habits.length) * 100 : 0}%` }} /></div></div>
        {isFuture && <div style={st.futureNote}>This day hasn't arrived yet.</div>}
        {isDesktop ? <div style={st.desktopGrid}><div style={st.desktopCol}>{col1.map(renderGroup)}</div><div style={st.desktopCol}>{col2.map(renderGroup)}</div></div> : <div>{grouped.map(renderGroup)}</div>}
        <button style={st.addHabitBtn} onClick={onAddHabit}>+ Add habit</button>
      </div>);
    }

    function HabitRow({ st, habit, dayLogs, dateKey, notes, checklistItems, toggle, toggleChecklistItem, adjust, openNote, onEdit, onDelete, onAddSubItem, onRemoveSubItem }) {
      const [expanded, setExpanded] = useState(false);
      const [menuOpen, setMenuOpen] = useState(false);
      const hasNote = (notes[`${dateKey}:${habit.id}`] || "").length > 0;
      const detail = dayLogs[habit.id + "_detail"] || {};
      const isDone = habit.type === "toggle" ? dayLogs[habit.id] : habit.type === "counter" ? (dayLogs[habit.id] || 0) >= habit.target : habit.type === "checklist" ? dayLogs[habit.id] : false;
      const clDone = habit.type === "checklist" ? checklistItems.filter(it => detail[it.id]).length : 0;
      return (<div style={{ marginBottom: 6, position: "relative" }}>
        <div style={{ ...st.habitRow, ...(isDone ? st.habitRowDone : {}), ...(habit.type === "checklist" && expanded ? { borderRadius: "12px 12px 0 0" } : {}) }}>
          <div style={st.habitLeft}><span style={{ ...st.habitIcon, color: isDone ? st.habitLabelDone.color : st.habitIcon.color }}>{habit.icon}</span>
            <div style={{ flex: 1, minWidth: 0 }}><div style={{ display: "flex", alignItems: "center", gap: 6 }}><span style={{ ...st.habitLabel, ...(isDone ? st.habitLabelDone : {}) }}>{habit.label}</span>{habit.type === "checklist" && checklistItems.length > 0 && <span style={st.clCount}>{clDone}/{checklistItems.length}</span>}</div>{hasNote && <span style={st.noteIndicator}>note saved</span>}</div></div>
          <div style={st.habitRight}>
            {habit.type === "toggle" && <button style={isDone ? st.checkDone : st.checkUndone} onClick={() => toggle(habit.id)}>{isDone ? "✓" : ""}</button>}
            {habit.type === "counter" && <div style={st.counterGroup}><button style={st.counterBtn} onClick={() => adjust(habit.id, -1)}>−</button><span style={st.counterVal}>{dayLogs[habit.id] || 0}<span style={st.counterTarget}>/{habit.target}</span></span><button style={st.counterBtn} onClick={() => adjust(habit.id, 1)}>+</button></div>}
            {habit.type === "checklist" && <button style={st.expandBtn} onClick={() => setExpanded(!expanded)}>{expanded ? "▴" : "▾"}</button>}
            <button style={st.menuBtn} onClick={() => setMenuOpen(!menuOpen)}>⋯</button>
            {menuOpen && <><div style={st.menuBackdrop} onClick={() => setMenuOpen(false)} /><div style={st.contextMenu}><button style={st.contextItem} onClick={() => { setMenuOpen(false); openNote(habit.id); }}><span style={st.ctxIcon}>✎</span>{hasNote ? "Edit note" : "Add note"}</button><div style={st.ctxDivider} /><button style={st.contextItem} onClick={() => { setMenuOpen(false); onEdit(); }}><span style={st.ctxIcon}>◎</span>Edit habit</button><button style={{ ...st.contextItem, ...st.contextItemDanger }} onClick={() => { setMenuOpen(false); onDelete(); }}><span style={st.ctxIcon}>✕</span>Delete habit</button></div></>}
          </div>
        </div>
        {habit.type === "checklist" && expanded && <div style={st.clDropdown}>{checklistItems.length === 0 && <p style={st.clEmpty}>No items yet — add your first one below.</p>}{checklistItems.map(it => (<div key={it.id} style={st.clRow}><button style={detail[it.id] ? st.clCheckDone : st.clCheckUndone} onClick={() => toggleChecklistItem(habit.id, it.id)}>{detail[it.id] ? "✓" : ""}</button><span style={{ ...st.clLabel, ...(detail[it.id] ? st.clLabelDone : {}) }}>{it.label}</span><button style={st.clRemove} onClick={() => onRemoveSubItem(it.id)}>×</button></div>))}<button style={st.addClBtn} onClick={onAddSubItem}>+ Add item</button></div>}
      </div>);
    }

    function WeeklyView({ st, habits, categories, weekDates, logs, checklists, navigateWeek, goToday, weekStats, gymCount, getHabitStatus, selectedDate, isDesktop, toggleHabitOn, toggleChecklistItemOn, adjustCounterOn, weekNote, setWeekNote, weekKey }) {
      const stats = weekStats(); const gym = gymCount(); const todayKey = dkf(new Date());
      const [expandedCells, setExpandedCells] = useState({});
      const [editingNote, setEditingNote] = useState(false);
      const [noteVal, setNoteVal] = useState(weekNote);
      useEffect(() => { setNoteVal(weekNote); setEditingNote(false); }, [weekKey, weekNote]);
      const toggleCellExpand = (hId, dk) => { const key = hId + ":" + dk; setExpandedCells(p => ({ ...p, [key]: !p[key] })); };
      const grouped = categories.map(c => ({ ...c, habits: habits.filter(h => h.category === c.id) })).filter(g => g.habits.length > 0);
      const orphans = habits.filter(h => !categories.some(c => c.id === h.category)); if (orphans.length) grouped.push({ id: "_other", label: "Other", habits: orphans });
      const lw = isDesktop ? 170 : 120;

      return (<div>
        <div style={st.weekNav}><button style={st.weekNavBtn} onClick={() => navigateWeek(-1)}>← Previous</button><span style={st.weekRange}>{fmtDate(weekDates[0])} – {fmtDate(weekDates[6])}</span><button style={st.weekNavBtn} onClick={() => navigateWeek(1)}>Next →</button></div>
        <div style={st.statsRow}><div style={st.statCard}><span style={st.statNum}>{stats.pct}%</span><span style={st.statLabel}>Overall</span></div><div style={st.statCard}><span style={{ ...st.statNum, color: gym >= 3 ? st.habitLabelDone.color : st.textFaint }}>{gym}/3</span><span style={st.statLabel}>Gym</span></div><div style={st.statCard}><span style={st.statNum}>{stats.done}</span><span style={st.statLabel}>Done</span></div></div>
        <div style={{ ...st.gridContainer, overflowX: "auto" }}><div style={{ minWidth: isDesktop ? "auto" : 600 }}>
          <div style={st.gridHeader}><div style={{ ...st.gridLabelCol, width: lw, minWidth: lw }} />{weekDates.map(d => <div key={dkf(d)} style={{ ...st.gridDayCol, ...(isTodayDate(d) ? st.gridDayToday : {}) }}><span style={st.gridDayName}>{DAYS[dayIdx(d)]}</span><span style={st.gridDayNum}>{d.getDate()}</span></div>)}</div>
          {grouped.map(group => <div key={group.id}>
            <div style={st.gridCatRow}><div style={{ ...st.gridLabelCol, width: lw, minWidth: lw }}><span style={st.gridCatLabel}>{group.label}</span></div>{weekDates.map(d => <div key={dkf(d)} style={{ ...st.gridCell, ...(isTodayDate(d) ? st.gridCellToday : {}), background: st.gridCatRow.background }} />)}</div>
            {group.habits.map(h => { const items = checklists[h.id] || []; return <div key={h.id}>
              <div style={st.gridRow}><div style={{ ...st.gridLabelCol, width: lw, minWidth: lw, paddingLeft: 24 }}><span style={st.gridHabitIcon}>{h.icon}</span><span style={st.gridHabitLabel}>{h.label}</span></div>
                {weekDates.map(d => { const dk = dkf(d); const future = dk > todayKey; const dl = logs[dk] || {};
                  if (future) return <div key={dk} style={{ ...st.gridCell, ...(isTodayDate(d) ? st.gridCellToday : {}) }}><span style={{ ...st.gridDot, ...st.gridDotFuture }}>·</span></div>;
                  if (h.type === "toggle") { const done = dl[h.id]; return <div key={dk} style={{ ...st.gridCell, ...(isTodayDate(d) ? st.gridCellToday : {}) }}><button style={done ? st.gridDotDoneBtn : st.gridDotMissedBtn} onClick={() => toggleHabitOn(dk)(h.id)}>{done ? "✓" : "—"}</button></div>; }
                  if (h.type === "counter") { const val = dl[h.id] || 0; const done = val >= h.target; return <div key={dk} style={{ ...st.gridCell, ...st.gridCellCol, ...(isTodayDate(d) ? st.gridCellToday : {}) }}><div style={st.gridCounterWrap}><button style={st.gridCounterBtn} onClick={() => adjustCounterOn(dk)(h.id, -1)}>−</button><span style={{ ...st.gridCounterVal, color: done ? st.habitLabelDone.color : st.habitLabel.color }}>{val}</span><button style={st.gridCounterBtn} onClick={() => adjustCounterOn(dk)(h.id, 1)}>+</button></div></div>; }
                  if (h.type === "checklist") { const det = dl[h.id + "_detail"] || {}; const dc = items.filter(it => det[it.id]).length; const allDone = items.length > 0 && dc === items.length; return <div key={dk} style={{ ...st.gridCell, ...st.gridCellCol, ...(isTodayDate(d) ? st.gridCellToday : {}) }}><button style={allDone ? st.gridDotDoneBtn : st.gridDotMissedBtn} onClick={() => items.length > 0 && toggleCellExpand(h.id, dk)}>{items.length > 0 ? `${dc}/${items.length}` : "—"}</button></div>; }
                  return <div key={dk} style={st.gridCell} />;
                })}</div>
              {h.type === "checklist" && items.map(it => { const anyExp = weekDates.some(d => expandedCells[h.id + ":" + dkf(d)]); if (!anyExp) return null; return (
                <div key={it.id} style={{ ...st.gridRow, ...st.gridSubRowBg }}><div style={{ ...st.gridLabelCol, width: lw, minWidth: lw, paddingLeft: 40 }}><span style={st.gridSubLabel}>{it.label}</span></div>
                  {weekDates.map(d => { const dk = dkf(d); if (dk > todayKey) return <div key={dk} style={{ ...st.gridCell, ...(isTodayDate(d) ? st.gridSubTodayBg : st.gridSubRowBg) }}><span style={{ ...st.gridDot, ...st.gridDotFuture }}>·</span></div>;
                    const dl = logs[dk] || {}; const det = dl[h.id + "_detail"] || {}; const done = det[it.id];
                    return <div key={dk} style={{ ...st.gridCell, ...(isTodayDate(d) ? st.gridSubTodayBg : st.gridSubRowBg) }}><button style={done ? st.gridSubDone : st.gridSubUndone} onClick={() => toggleChecklistItemOn(dk)(h.id, it.id)}>{done ? "✓" : ""}</button></div>; })}</div>); })}
            </div>; })}
          </div>)}
        </div></div>

        <div style={st.weekNoteWrap}><div style={st.weekNoteHeader}><span style={st.weekNoteTitle}>Week note</span>{!editingNote && weekNote && <button style={st.weekNoteEditBtn} onClick={() => setEditingNote(true)}>✎</button>}</div>
          {editingNote || !weekNote ? <div><textarea style={st.textarea} value={noteVal} onChange={e => setNoteVal(e.target.value)} rows={2} placeholder="How was this week? Anything to carry forward?" autoFocus={editingNote} /><div style={{ display: "flex", justifyContent: "flex-end", gap: 6, marginTop: 6 }}>{weekNote && <button style={st.modalCancel} onClick={() => { setNoteVal(weekNote); setEditingNote(false); }}>Cancel</button>}<button style={st.modalSave} onClick={() => { setWeekNote(noteVal); setEditingNote(false); }}>Save</button></div></div>
            : <p style={st.weekNoteText} onClick={() => setEditingNote(true)}>{weekNote}</p>}
        </div>
        {!weekDates.some(d => isTodayDate(d)) && <button style={st.goTodayBtn} onClick={goToday}>Back to this week</button>}
      </div>);
    }

    // Render the app
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<HabitTracker />);
  </script>
</body>
</html>
